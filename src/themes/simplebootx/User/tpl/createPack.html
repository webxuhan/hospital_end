<!-- 快件下单 -->
  <ul class="placeOrder-head">
    <li onclick="otype(1)">{:L("GENERAL_ORDER")}</li>
    <li onclick="otype(3)">{:L("INWARD_ORDER")}</li>
    <li class="placeOrder-current">{:L("PACKAGE_ORDER")}</li>
  </ul>
  <!--内部件-->
  <div class="placeOrder-content inwardOrder">
    <form id="pack">
      <div class="mailType"><span>{:L("RECEIVE_TYPE")}:</span>
            <select name="service_type" id="service_type">
                <option value="0">{:L("RECEIVE_DOMESTIC")}</option>
                <option value="1">{:L("RECEIVE_ABROARD")}</option>
            </select>
            <span></span>
        </div>
      <div class="packaddress"><span>{:L("DEMASTIC_PLACE")}:</span>
        <select name="package_address_id">
            <foreach name="address_list" item="vo">
                <option value="{$vo.address_id}">
                    {$vo.address_name}
                </option>
            </foreach>

        </select>
      </div>
      <div class="clearfix receiveName">
            <span class="recipients"><span>{:L("RECEIVER")}:</span><input type="text" name="receive_name" value="{$daddress.delivery_name}"></span><span class="errhiden">{:L("RECEIVE_NAME_REQUIRED")}</span>
        </div>
        <div class="contactPhone">   
            <span>{:L("MOBILE")}:</span><input type="text" name="receive_phone" value="{$daddress.delivery_mobile}">
            <span class="errhiden">{:L("MOBILE_NOT_NULL_DEFEAT")}</span>
        </div>
      <div class="mailAddress"><span>{:L("RECIPIENT_ADDRESS")}:</span>
        <select mailroom_regions data-regions="{$daddress.delivery_address}" name="regions_area_id" class="address1"></select>
        <div>
            <textarea rows="3" cols="40" name="receive_address" value="{$daddress.delivery_street}">{$daddress.delivery_street}</textarea>（{:L("DETAIL_ADDRESS")}）
        </div>
      </div>
      <div class="numberType"><span>{:L("SERIAL_NUM")}:</span>
            <select name="number_type" id="number_type">
                <option value="1">{:L("PRE_PRINT")}</option>
                <option value="2">{:L("SYSTEM_GENERATE")}</option>
            </select>
        </div>
        <div class="parcelNumber"><span>{:L("PACKAGE_NUM")}:</span>
            <input type="text" value="1" name="express_quantity" id="express_quantity" min="1" onkeyup="NumberCheck(this)">

            <span class="hint">{:L("SYSTEM_DEFAULT")}</span>
            <div class="tag_number">
                <span>{:L("SIGN_NUMBER")}1</span>
                <input type="text" name="serial_number[]" value="">
                <span class="errhiden">{:L("WRITE_SIGN_NUMBER")}</span>
                <span class="errhiden">{:L("REPEAT_SIGN_NUMBER")}</span>
            </div>
        </div>
      <button class="submit packBtn" id="subbtn" type="button">{:L("BTN_REFER")}</button>
      <button class="reset" type="reset">{:L("CANCEL")}</button>
    </form>
  </div>
  
<script src="__PUBLIC__/js/common.js"></script>      
<script src="__PUBLIC__/js/region_data.js"></script>
<script src="__PUBLIC__/js/regions_plugin.js"></script>
<script>
    var noty_btn = false; //btn开关
    function NumberCheck(t){ //输入框只能为正整数
        var num = t.value;
        if(num < 0){num = 1}
        var re=/^\d*$/;
        if(!re.test(num)){
            isNaN(parseInt(num))?t.value=0:t.value=parseInt(num);
        }
    }   
    $(function(){
        //流水号类型
        $("#number_type").change(function () {
            var number_type = $(this).val();
            if (number_type == 2) {
                $("#express_quantity").val(1);
                $("#express_quantity").change();
                $(".parcelNumber div").hide();
            } else {
                $("#express_quantity").val(1);
                $("#express_quantity").change();
                $(".parcelNumber div").show();
            }
        });
         //标签数量
        $("#express_quantity").change(function () {
            var number_type = $("#number_type").val();
            var express_quantity = $("#express_quantity").val();
            var orginLegth = $(".parcelNumber div input[type='text']").length;
            var num = express_quantity - orginLegth;
            //增加
            if (number_type == 1 && num > 0) {
                //克隆元素
                for (var i = 0; i < num; i++) {
                    $(".tag_number:not(:first)").removeClass("tag_number");
                    var clone = $(".tag_number").clone(true);
                    var ctext = '{:L("SIGN_NUMBER")}' + Number(orginLegth + 1 
                        + i);
                    var a = clone.children("span").first().text(ctext);
                    var b = clone.children("input").val("");
                    var c = clone.children(".errhiden").css("display","none");
                    $(".parcelNumber").append(clone);
                    $(".sidebar-nav").css('height',$('.rightBox').height());
                }
            }else if(number_type == 1 && num < 0){ //删除
                $(".parcelNumber div").slice(express_quantity).remove();
                $(".sidebar-nav").css('height',$('.rightBox').height());
            }
        });
        /*验证*/
        //收件人姓名不能为空
        $("input[name='receive_name']").on("blur",function(){
            if($(this).val() == ""){
                $(".receiveName .errhiden").css("display","inline-block");
            }else{
                $(".receiveName .errhiden").css("display","none");
                $(this).removeClass("errorInput");
            }
        });
        //收件人电话
        $("input[name='receive_phone']").on("blur",function(){
            if($(this).val() == ""){
                $(".contactPhone .errhiden").css("display","inline-block");
            }else{
                var phonebool = /^1(3|4|5|7|8)\d{9}$/.test($(this).val());
                if(phonebool){
                    $(".contactPhone .errhiden").css("display","none");
                    $(this).removeClass("errorInput");
                }else{
                    $(".contactPhone .errhiden").css("display","inline-block");
                }
            }
        });
        //包裹数量
         $("#express_quantity").on("blur",function(){
            var s = $(this).val();
            if(isNaN(s)){
                 noty({
                    text: "{:L('PLEASE_SURE_QUANTITY')}",
                    type: "error",
                    layout: "center"
                });
            };
            NumberCheck(this);
        });
        //标签号码不能为空且不能为汉字
        $("input[name='serial_number[]']").on("blur",function(){
            var serialbool = /^[u4E00-u9FA5\-]+$/.test($(this).val());
            if($(this).val() =="" || !serialbool){
                $(this).next().css("display","inline-block");
            }else{
                $(this).next().css("display","none");
                var currentVal = $(this).val(); 
                var serial_arr = new Array();
                $(this).parent().siblings("div").each(function(){
                   //将当前选中输入框的兄弟输入框push
                    serial_arr.push($(this).children("input").val());
                });
                if($.inArray(currentVal,serial_arr) != -1){ //标签号码不能重复
                    $(this).next().next().css("display","inline-block");
                }else{
                    $(this).next().next().css("display","none");
                    $(this).removeClass("errorInput");
                }
                serial_arr.splice(0,serial_arr.length);         
            }     
        });
        /*验证结束*/
        //提交
        var noty_btn = true;
        $("#subbtn").on('click',function(){
            if(noty_btn == false){
                return false;
            }
            noty_btn = false;
            setTimeout(function(){
                noty_btn = true;
            },2000);
            //收货地址
            var addr = $("input[name = 'address']").val();
            if($("input[name = 'address']").val() == ""){
               noty({
                text: '{:L("PLEASE_SELECT_ADDRESS")}',
                type: "error",
                layout: "center"
               });
                return false;
            }
            //收件人是否为空
            if($("input[name='receive_name']").val() == ""){$("input[name='receive_name']").addClass("errorInput")}
            //收件号码是否为空
            if($("input[name='receive_phone']").val()==""){$("input[name='receive_phone']").addClass("errorInput")}
           //验证是否成功
            var verification = "";
            $(".errhiden").each(function(){
                if($(this).css("display") == "inline-block"){
                    verification = 1;
                    return false;
                }else{
                    verification = 0;
                }
            });
            //标签号码是否为空
            var serialnum = "";
            $("input[name='serial_number[]']").each(function(){
                if($(this).val() == "" && $(this).is(':visible')){
                    serialnum = 1;
                    $(this).addClass("errorInput");
                }else{
                    serialnum = 0;
                }
            });
             //地址判断
            if($(".mailAddress select:first").val()==""){
                 noty({
                    text: "{:L('PLEASE_SELECT_ADDRESS')}",
                    type: "error",
                    layout: "center"
                });
                return false;
            }
            if(addr == "" || verification == 1 || serialnum == 1 || $("input[name='receive_name']").val() == "" || $("input[name='receive_phone']").val()==""){
                var id =noty({
                    text: "{:L('COMPLETE_INFO')}",
                    type: "error",
                    layout: "center"
                });
            }else{
              $.ajax({
                    url:'{:U("PlaceOrder/packSend")}',
                    method:'post',
                    data:$("#pack").serialize(),
                    success:function(data){
                        if(data.status == 1){
                            noty({

                                  text: data.info,
                                  type:"success",
                                  layout:"center"
                            });
                            $(".reset").trigger("click");
                        }else{
                            noty({

                                  text: data.info,
                                  type:"error",
                                  layout:"center"
                            });
                        }
                    }
                });
            }
            return false;
        });
        //取消
        $('.reset').on('click',function(){
             $(".parcelNumber div:not(:first)").remove();
              $(".costCenter .cname").remove();
        });
    })
</script>