<!-- 快件下单 -->
<ul class="placeOrder-head">
    <li class="placeOrder-current">{:L("GENERAL_ORDER")}</li>
    <li onclick="otype(3)">{:L("INWARD_ORDER")}</li>
    <li onclick="otype(2)">{:L("PACKAGE_ORDER")}</li>
</ul>

<!-- 普通快递 -->
<div class="placeOrder-content generalOrder" style="display: block">
    <form id="general">
        <div class="mailType"><span>{:L("RECEIVE_TYPE")}:</span>
            <select name="service_type" id="service_type">
                <option value="0">{:L("RECEIVE_DOMESTIC")}</option>
                <option value="1">{:L("RECEIVE_ABROARD")}</option>
            </select>
            <span></span>
        </div>
        <div class="clearfix receiveName">
            <span class="recipients"><span>{:L("RECEIVER")}:</span><input type="text" name="receive_name" value="{$daddress.delivery_name}"></span><span class="errhiden">{:L("RECEIVE_NAME_REQUIRED")}</span>
        </div>
        <div class="contactPhone">   
            <span>{:L("MOBILE")}:</span><input type="text" name="receive_phone" value="{$daddress.delivery_mobile}">
            <span class="errhiden">{:L("MOBILE_NOT_NULL_DEFEAT")}</span>
        </div>

        <div class="mailAddress"><span>{:L("RECIPIENT_ADDRESS")}:</span>
            <select mailroom_regions data-regions="{$daddress.delivery_address}" id="select_delivery_address" name="regions_area_id" class="address1">
            </select>
            <div>
                <textarea rows="3" cols="40" name="receive_address" value="{$daddress.delivery_street}">{$daddress.delivery_street}</textarea>（{:L("DETAIL_ADDRESS")}）
            </div>
        </div>
        <div class="parcelWeight"><span>{:L("ESTIMATED_WEIGHT")}:</span>
            <input type="text" name="estimated_weight" id="weight" onblur="weightTextBlur(this)"> g
            <span class="errhiden"> {:L("CORRECT_ESTIMATED_WEIGHT")}</span>
        </div>
        <div class="expressCompany"><span>{:L("EXPRESS_NAME")}:</span>
            <select name="express_company_id" id="express_company_id">
                <option>{:L("SELECT_EXPRESS_COMPANY")}</option>
                <foreach name="express_company" item="ec">
                    <option value="{$ec.express_id}">{$ec.express_name}</option>
                </foreach>
            </select>
            <span class="hint">{:L("SUPER_EXPRESS_COMPANY")}</span>
            <span class="errhiden">{:L("EXPRESS_COMPANY_NOT_NULL")}</span>
        </div>
        <div class="expense"><span>{:L("COST")}:</span>
            <input type="text" value="0.00" name="estimated_expenses" id="estimated_expenses"> {:L("MONEY")}
        </div>
        <div class="costCenter"><span>{:L("COSTCENTER")}:</span><span class="costselect">{:L("CHOOSE")}</span>
        </div>
        <div class="numberType"><span>{:L("SERIAL_NUM")}:</span>
            <select name="number_type" id="number_type">
                <option value="1">{:L("PRE_PRINT")}</option>
                <option value="2">{:L("SYSTEM_GENERATE")}</option>
            </select>
        </div>
        <div class="parcelNumber"><span>{:L("PACKAGE_NUM")}:</span>
            <input type="text" value="1" name="express_quantity" id="express_quantity" min="1" onkeyup="NumberCheck(this)">

            <span class="hint">{:L("SYSTEM_DEFAULT")}</span>
            <div class="tag_number">
                <span>{:L("SIGN_NUMBER")}1</span>
                <input type="text" name="serial_number[]" value="">
                <span class="errhiden">{:L("WRITE_SIGN_NUMBER")}</span>
                <span class="errhiden">{:L("REPEAT_SIGN_NUMBER")}</span>
            </div>
        </div>
        <button class="submit generalBtn" type="button">{:L("BTN_REFER")}</button>
        <button class="reset" type="reset">{:L("CANCEL")}</button>
        <input type="reset" name="reset" style="display: none;" />
    </form>
</div>

</div>
<script src="__PUBLIC__/js/common.js"></script>
<script src="__PUBLIC__/js/region_data.js"></script>
<script src="__PUBLIC__/js/regions_plugin.js"></script>
<script src="__PUBLIC__/js/util/freightCalculationAjax.js"></script>
<script>
    function NumberCheck(t){ //输入框只能为整数
        var num = t.value;
        var re=/^\d*$/;
        if(!re.test(num)){
            isNaN(parseInt(num))?t.value=0:t.value=parseInt(num);
        }
    } 
    function weightTextBlur(obj) { //重量算法
        var weight = obj.value;
        var idx = obj.getAttribute("data-idx");
        if (weight) {
            if (isNaN(weight)) {
                obj.value = "";
                return false;
            }
            var regions_id = $("#select_delivery_address").val();
            if (!regions_id) {
                $("#weight").val("");
                noty({
                    text: '{:L("PLEASE_SELECT_ADDRESS")}',
                    type:"error",
                    layout:"center"
                 });    

                return false;
            }
            var service_type = $("#service_type").val();
            //获取价格 区域ID，国际或国内 地址，回调方法
            getBestExressPrice(regions_id, service_type, weight, "{:U('Express/SystemUtil/bestExpressPrice')}", funtest,funerror);
        // $("#expenses"+idx).val(price);
        }
    }
    function funtest (id, price) {
        //alert("快递公司ID:" + id + "----" + "价格：" + price);
        $("#express_company_id").val(id);
        $("#estimated_expenses").val(price);
    }
    function funerror(msg){
        noty({
            text: msg,
            type:"error",
            layout:"center"
         });  
    }
    $(function(){
        //流水号类型
        $("#number_type").change(function () {
            var number_type = $(this).val();
            if (number_type == 2) {
                $("#express_quantity").val(1);
                $("#express_quantity").change();
                $(".parcelNumber div").hide();
            } else {
                $("#express_quantity").val(1);
                $("#express_quantity").change();
                $(".parcelNumber div").show();
            }
        });
        //标签数量
        $("#express_quantity").change(function () {
            var number_type = $("#number_type").val();
            var express_quantity = $("#express_quantity").val();
            var orginLegth = $(".parcelNumber div input[type='text']").length;
            var num = express_quantity - orginLegth;
            //增加
            if (number_type == 1 && num > 0) {
                //克隆元素
                for (var i = 0; i < num; i++) {
                    $(".tag_number:not(:first)").removeClass("tag_number");
                    var clone = $(".tag_number").clone(true);
                    var ctext = '{:L("SIGN_NUMBER")}' + Number(orginLegth + 1 
                        + i);
                    var a = clone.children("span").first().text(ctext);
                    var b = clone.children("input").val("");
                    var c = clone.children(".errhiden").css("display","none");
                    $(".parcelNumber").append(clone);
                    $(".sidebar-nav").css('height',$('.rightBox').height());
                }
            }else if(number_type == 1 && num < 0){ //删除
                $(".parcelNumber div").slice(express_quantity).remove();
                $(".sidebar-nav").css('height',$('.rightBox').height());
            }
        });
        //成本中心选择
        $(".costselect").on('click', function () {
            //添加成本中心弹出层
            var costids = $(".costids").val();
            Wind.use('artDialog', 'iframeTools', function () {
                var url = "{:U('PlaceOrder/costselect')}"+"&costids="+costids;
                art.dialog.open(url, {
                    title: '{:L("SELECT_COSTCENTER")}',
                    lock: true,
                    height: "40%",
                    width: "50%",
                    // 在open()方法中，init会等待iframe加载完毕后执行
                    init: function () {
                        var iframe = this.iframe.contentWindow;
                        var top = art.dialog.top;// 引用顶层页面window对象
                    },
                    ok: function () {
                        var iframe = this.iframe.contentWindow;
                        if (!iframe.document.body) {
                            art.dialog.tips('Loading......', 1.5);
                            return false;
                        }

                        // 获取iframe嵌套内容
                        var center_id = new Array();
                        var checkbox = iframe.document.getElementsByName('costcenter');
                        $(".cname").remove();
                        $(".costids").remove();
                        for (var i = 0; i < checkbox.length; i++) {
                            
                            if (checkbox[i].checked == true) {
                                var center_name = checkbox[i].getAttribute('centername');
                                center_id.push(checkbox[i].value); 
                                var a = "<span class='cname'>" + center_name + "</span>";
                                $(".costCenter").append(a);
                            }

                        }
                        var sinput = "<input type='hidden' class='costids' name='center_id' value="+center_id+">"
                         $(".costCenter").append(sinput);

                    },
                    cancel: true
                });
            });
        });
        /*验证*/
        //收件人姓名不能为空
        $("input[name='receive_name']").on("blur",function(){
            if($(this).val() == ""){
                $(".receiveName .errhiden").css("display","inline-block");
                // $(this).addClass("errorInput");
            }else{
                $(".receiveName .errhiden").css("display","none");
                $(this).removeClass("errorInput");
            }
        });
        //收件人电话
        $("input[name='receive_phone']").on("blur",function(){
            if($(this).val() == ""){
                $(".contactPhone .errhiden").css("display","inline-block");
                // $(this).addClass("errorInput");
            }else{
                var phonebool = /^1(3|4|5|7|8)\d{9}$/.test($(this).val());
                if(phonebool){
                    $(".contactPhone .errhiden").css("display","none");
                    $(this).removeClass("errorInput");
                }else{
                    $(".contactPhone .errhiden").css("display","inline-block");
                    // $(this).addClass("errorInput");
                }
            }
        });
        //预计重量
        $("input[name='estimated_weight']").on("blur",function(){
            if($(this).val() == ""){ //验证
                $(".parcelWeight .errhiden").css("display","inline-block");
                // $(this).addClass("errorInput");
            }else{
                var weightbool = /^[1-9]\d*\.\d*|0\.\d*[1-9]\d|([1-9][0-9]*){1,3}$/.test($(this).val());
                if(weightbool){
                    $(".parcelWeight .errhiden").css("display","none");
                     $(this).removeClass("errorInput");
                }else{
                    $(".parcelWeight .errhiden").css("display","inline-block");
                    // $(this).addClass("errorInput");
                }
            }
        });
        //快递公司
        $("#express_company_id").on("change",function(){
            if($(this).val() == "{:L('SELECT_EXPRESS_COMPANY')}"){
                $(".expressCompany .errhiden").css("display","inline-block");
                 // $(this).addClass("errorInput");
            }else{
                $(".expressCompany .errhiden").css("display","none");
                 $(this).removeClass("errorInput");
            }
        });
        //包裹数量
        $("#express_quantity").on("blur",function(){
            var s = $(this).val();
            if(isNaN(s)){
                 noty({
                    text: "{:L('PLEASE_SURE_QUANTITY')}",
                    type: "error",
                    layout: "center"
                });
            };
            NumberCheck(this);
        });
        /*标签号码不能为空,且不能为汉字*/
        $("input[name='serial_number[]']").on("blur",function(){
            var serialbool = /^[u4E00-u9FA5\-]+$/.test($(this).val());
            if($(this).val() =="" || !serialbool){
                $(this).next().css("display","inline-block");
            }else{
                $(this).next().css("display","none");
                var currentVal = $(this).val(); 
                var serial_arr = new Array();
                $(this).parent().siblings("div").each(function(){
                   //将当前选中输入框的兄弟输入框push
                    serial_arr.push($(this).children("input").val());
                });
                if($.inArray(currentVal,serial_arr) != -1){ //标签号码不能重复
                    $(this).next().next().css("display","inline-block");
                }else{
                    $(this).next().next().css("display","none");
                     $(this).removeClass("errorInput");
                }
                serial_arr.splice(0,serial_arr.length);         
            }   
        });
        /*验证结束*/
        //提交
        var noty_btn = true; //btn开关
        $(".generalBtn").on('click', function () {
             if(noty_btn == false){
                  return false;
              }
              noty_btn = false;
              setTimeout(function(){
                  noty_btn = true;
              },2000);
            //验证是否成功
            var verification = "";
            $(".errhiden").each(function(){
                if($(this).css("display") == "inline-block" ){
                    verification = 1;
                    return false;
                }else{
                    verification = 0;
                }
            });
            //收件人是否为空
            if($("input[name='receive_name']").val() == ""){$("input[name='receive_name']").addClass("errorInput")}
            //收件号码是否为空
            if($("input[name='receive_phone']").val()==""){$("input[name='receive_phone']").addClass("errorInput")}
            //重量是否为空
            var weight =  $("#weight").val();
            if(weight == ''){$("#weight").addClass("errorInput");}
            //标签号码是否为空
            var serialnum = "";
            $("input[name='serial_number[]']").each(function(){
                if($(this).val() == "" && $(this).is(':visible')){
                    serialnum = 1;
                    $(this).parent().children("input").addClass("errorInput");
                }else{
                    serialnum = 0;
                }
            });
            //地址判断
            if($(".mailAddress select:first").val()==""){
                 noty({
                    text: "{:L('PLEASE_SELECT_ADDRESS')}",
                    type: "error",
                    layout: "center"
                });
                return false;
            }
            if(verification == 1 || weight == "" || serialnum == 1 || $("input[name='receive_name']").val() == "" || $("input[name='receive_phone']").val()==""){
                noty({
                    text: "{:L('COMPLETE_INFO')}",
                    type: "error",
                    layout: "center"
                });
            }else{
                //提交数据
                $.ajax({
                    url: '{:U("PlaceOrder/generalSend")}',
                    method: 'post',
                    data: $("#general").serialize(),
                    success: function (data) {
                        if (data.status == 1) {
                            noty({
                                text: data.info,
                                type: "success",
                                layout: "center"
                            });
                            $(".reset").trigger("click");
                        } else {
                            noty({

                                text: data.info,
                                type: "error",
                                layout: "center"
                            });
                        }
                    }
                });
            }     
            return false;
        });
        //取消
        $('.reset').on('click',function(){
               $(".parcelNumber div:not(:first)").remove();
               $(".costCenter .cname").remove();
        });
    });
    
</script>