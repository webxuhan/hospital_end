<admintpl file="header"/>
</head>

<body>
<style>
    .td_top {
        border-top: solid #e6e4e7 2px;
        padding-top: 10px;
    }
</style>
<div class="wrap js-check-wrap">
    <ul class="nav nav-tabs">
        <li><a href="{:U('Sending/index')}">{:L("SENDING_TITLE")}</a></li>
        <li><a href="{:U('Sending/create')}">{:L("SENDING_CREATE")}</a></li>
        <li class="active"><a href="{:U('Sending/createPackage')}">{:L("SENDING_CREATE_PACKAGE")}</a></li>
    </ul>


    <fieldset>
        <div class="control-group">
            <table border="1" cellpadding="3" cellspacing="0" width="100%">
                <tr>
                    <td width="50%">
                        <form method="post" id="sendForm" class="form-horizontal js-ajax-form" action="{:U('Sending/packageSave')}" id="sendForm">
                            <input type="hidden" name="express_type" value="2">
                            <input type="hidden" name="service_type" value="1">
                            <input type="hidden" name="send_staff_id" id="send_staff_id">
                            <input type="hidden" name="send_staff_id" id="receive_staff_id">
                            <table border="0" cellpadding="3" cellspacing="0" width="100%">
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="2" width="110px">{:L('SERIAL_NUMBER')}:</td>
                                    <td colspan="4">
                                        <input type="text"  id="serial_number" name="serial_number">
                                        <span class="form-required">*</span>
                                    </td>
                                    <td colspan="2">{:L('EXPRESS_QUANTITY')}:</td>
                                    <td colspan="2">
                                        <input type="text" style="width: 80px" name="express_quantity" id="express_quantity"
                                               value="1">
                                        <span class="form-required">*</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        {:L("PACKAGE_ADDRESS")}:
                                    </td>
                                    <td colspan="4">
                                        <select name="package_address_id" id="package_address_id">
                                            <option>
                                                {:L('TO_CHOOSE')}{:L('PACKAGE_ADDRESS')}
                                            </option>
                                            <foreach name="address_list" item="vo">
                                                <option value="{$vo.address_id}">
                                                    {$vo.address_name}
                                                </option>
                                            </foreach>


                                        </select>
                                    </td>
                                    <td colspan="2">{:L("WEIGHT")}:</td>
                                    <td colspan="2">
                                        <input type="text" style="width: 70px;" data-idx="1"
                                               id="weight" name="weight">{:L("WEIGHT_UNIT")}
                                    </td>

                                </tr>
                                <tr>
                                    <td class="td_top" colspan="2"></td>
                                    <td class="td_top" colspan="8">
                                        <button type="button" class="btn btn-primary js-ajax-submit" id="checkStaff">
                                            {:L('CHECK_USER')}
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">{:L("SENDING_NAME")}:</td>
                                    <td colspan="2">
                                        <input type="text" style="width:135px;" name="sending_name" id="sending_name" disabled>
                                    </td>
                                    <td colspan="2">
                                        {:L("SENDING_PHONE")}:
                                    </td>
                                    <td colspan="4">
                                        <input type="text" style="width:135px;" name="sending_phone" id="sending_phone" disabled>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">{:L("SENDING_DEPARTMENT")}:</td>
                                    <td colspan="2">
                                        <input type="text" style="width:135px;" name="sending_department" id="sending_department" disabled>
                                    </td>
                                    <td colspan="2">
                                        {:L("SENDING_PATH")}:
                                    </td>
                                    <td colspan="4">
                                        <input type="text" style="width: 135px" name="sending_path" id="sending_path"
                                               disabled>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">{:L("SENDING_COMMENT")}:</td>
                                    <td colspan="8">
                                        <textarea style="width: 400px;" rows="2" name="sending_comment" disabled></textarea>
                                    </td>

                                </tr>
                                <tr>
                                    <td class="td_top" colspan="2">
                                        {:L("RECEIVING_NAME")}:
                                    </td>
                                    <td class="td_top" colspan="2">
                                        <input type="text" name="receive_name" style="width: 135px" id="receive_name">
                                    </td>
                                    <td class="td_top" colspan="2">
                                        {:L("RECEIVING_PHONE")}:
                                    </td>
                                    <td class="td_top" colspan="4">
                                        <input type="text" name="receive_phone" style="width: 135px" id="receive_phone">
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        {:L("RECEIVING_ADDRESS")}:
                                    </td>
                                    <td colspan="8">
                                        <select mailroom_regions data-regions="1"  name="address" class="address1"></select>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">{:L("RECEIVING_ADDRESS_INFO")}:</td>
                                    <td colspan="8">
                                        <textarea style="width: 400px;" rows="1" name="receive_address"
                                                  id="receive_address"></textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="10">
                                        <table id="item_table" width="100%">
                                            <tr>
                                                <td >1</td>
                                                <td>
                                                    {:L("WEIGHT")}:
                                                </td>
                                                <td >
                                                    <input type="text" style="width: 50px;" onblur='weightTextBlur(this)' data-idx="1"
                                                           id="weight1" name="weight1">{:L("WEIGHT_UNIT")}
                                                </td>

                                            </tr>
                                        </table>
                                    </td>

                                </tr>
                            </table>
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary js-ajax-submit" id="subbuttom">{:L('ADD')}</button>
                                <!--<a class="btn" href="javascript:history.back(-1);">{:L('BACK')}</a>-->
                            </div>
                        </form>
                    </td>
                    <td width="50%" valign="top">
                        <form class="" action="{:U('Sending/createPackage')}" method="post" id="form2">
                            <input type="hidden" name="style" value="moment">

                            <select name="package_address_id" id="package_address_id_form" onchange="addressChange()">
                                <option value="">
                                    {:L('TO_CHOOSE')}{:L('PACKAGE_ADDRESS')}
                                </option>
                                <foreach name="address_list" item="vo">
                                    <option value="{$vo.address_id}" >
                                        {$vo.address_name}
                                    </option>
                                </foreach>
                            </select>

                            <script>
                                $("#package_address_id_form").val("{:I('request.package_address_id/s')}");
                            </script>

                            <table class="table table-hover table-bordered table-list" style="width:120%;">

                                <thead>
                                <tr>
                                    <th><label><input type="checkbox" class="js-check-all" data-direction="x"
                                                      data-checklist="js-check-x"></label></th>
                                    <th>{:L("SERIAL_NUMBER")}</th>
                                    <!--<th>{:L("PACKAGE_ADDRESS")}</th>-->
                                    <th>{:L("WEIGHT")}</th>
                                    <th>{:L("SEND_TIME")}</th>
                                    <th>{:L("ACTIONS")}</th>
                                </tr>
                                </thead>
                                <tbody>
                                <foreach name="sendList" item="vo">
                                    <tr>
                                        <td>
                                            <label class="checkbox inline">
                                                <input type="checkbox" class="js-check" data-yid="js-check-y" data-xid="js-check-x"
                                                       name="ids[]" value="{$vo.id}" title="ID:{$vo.id}">
                                            </label>
                                        </td>


                                        <td>
                                            <!--{$vo.serial_number} - {$vo.app_number}-->
                                            <foreach name="vo['items']" item="item">
                                                {$item.serial_number} - {$item.app_number}<br>
                                            </foreach>
                                        </td>
                                        <!--<td>{$vo.address_name}</td>-->
                                        <td>{$vo.weight} {:L("WEIGHT_UNIT")}</td>


                                        <td>{$vo.create_time|format_day_time}</td>
                                        <!--<td>{:L("APPLICATION_STATUS_$vo[status]")}</td>-->

                                        <td>
                                            <!--<a href='{:U("Staff/edit",array("staff_id"=>$vo["staff_id"]))}'>{:L('EDIT')}</a> |-->
                                            <a class="js-ajax-delete" href="{:U('Sending/delete',array('id'=>$vo['id']))}">{:L('DELETE')}</a>
                                        </td>
                                    </tr>
                                </foreach>
                                </tbody>

                            </table>

                            <div class="table-actions">
                                <button class="btn btn-danger btn-small js-ajax-submit" type="submit" data-action="{:U('Sending/delete')}"
                                        data-subcheck="true" data-msg="{:L('DELETE_CONFIRM_MESSAGE')}">{:L('DELETE')}
                                </button>
                                <!--<button class="btn btn-primary btn-small " type="button">{:L('DATA_IMPORT')}</button>-->
                                <!--<button class="btn btn-primary btn-small " type="button">{:L('DATA_EXPORT')}</button>-->
                                <button class="btn btn-primary btn-small js-ajax-submit" id="package_btn" type="button" onclick="sendPackage(this)" data-action="{:U('Sending/packageItem')}"
                                >{:L('PACKAGE')}
                                </button>


                            </div>
                        </form>
                    </td>
                </tr>
            </table>

        </div>



    </fieldset>



</div>
<script src="__PUBLIC__/js/common.js"></script>
<script src="__PUBLIC__/js/region_data.js"></script>
<script src="__PUBLIC__/js/regions_plugin.js"></script>
<script src="__PUBLIC__/js/util/freightCalculationAjax.js"></script>
<script src="__PUBLIC__/js/util/staffAjax.js"></script>
<script type="text/javascript">

    //标记当前添加快递单类型 0:通过快递单号 ，1:通过快递单号新增加快递信息与快递申请，2：通过打印的标签修改原有的数据信息
    var expressNumberType = 0;

    var receiveTableCopy = "";

    //监控界面快捷键，
    document.onkeyup = function (e) {
        if (e.shiftKey && e.keyCode == 49) {
            alert(e.keyCode);
        }
    }


    //ajax 获取员工信息
    function getStaffByJson(send_staff_json) {
        var obj = eval('(' + send_staff_json + ')');
        $("#send_staff_id").val(obj.staff_id);
        $("#sending_name").val(obj.zn_name);
        $("#sending_phone").val(obj.mobile);
        $("#sending_department").val(obj.department_name);
        $("#sending_phone").val(obj.mobile);
        $("#sending_path").val(obj.seat_detail);

    }

    //获取ajax回调staff 数据
    var staffData = function (data) {
        if (data.retCode == '1') {
            alert(data.retMsg);
            return;
        }
        if (data.retCode == '0') {
            if (data.staff.turnover_status != 0) {
                alert(data.retMsg);
            }
            $("#send_staff_id").val(data.staff.staff_id);
            $("#sending_name").val(data.staff.zn_name);
            $("#sending_phone").val(data.staff.mobile);
            $("#sending_department").val(data.staff.department_name);
            $("#sending_phone").val(data.staff.mobile);
            var path = data.staff.seat_detail;
            $("#sending_path").val(path);
        }
    }


    //获取快递信息通过流水号
    function getSendingExpress() {
        var number = $("#serial_number").val();
        if (number) {
            $.ajax({
                url: "{:U('Sending/getSendExpress')}",
                type: 'post',
                dataType: 'json',
                data: {"serialNumber": number},
                success: function (data) {
                    console.log(data);

                    if (data.retCode == '0') {
                        getStaffById(data.sendingExpress.sendApplication.send_staff_id, "{:U('SystemUtil/checkStaff')}", staffData);
                        $("#express_type").val(data.sendingExpress.sendApplication.express_type);
                        $("#send_staff_id").val(data.sendingExpress.sendApplication.send_staff_id);
                        $("#express_quantity").val(data.sendingExpress.sendApplication.express_quantity);
                        expressNumberType = data.sendingExpress.sendApplication.number_type;
                        buildItem(data.sendingExpress.sendItems);

                        $("#receive_name").val(data.sendingExpress.sendApplication.receive_name);
                        $("#receive_phone").val(data.sendingExpress.sendApplication.receive_phone);
                        $("#receive_zip").val(data.sendingExpress.sendApplication.receive_zip);
                        $("#receive_address").val(data.sendingExpress.sendApplication.receive_address);

                        $("#package_address_id").val(data.sendingExpress.sendApplication.package_address_id);

//                        $(".address1").attr("data-regions",data.sendingExpress.regions_area_id);
//                        regionInitialize();
                    } else {
                        alert(data.retMsg);
                        return;
                    }
                },
                error: function (data, status, e) {
                    alert(data.retMsg);
                }
            });
        }

    }

    //根据包裹数量添加
    function buildItem(numbers) {
        var htmlStr = "";
        var quantity = $("#express_quantity").val();
        var serial_number = $("#serial_number").val();
        for (var i = 0; i < quantity; i++) {
            var number = "";
            if(expressNumberType == 0){
                number = i + 1;
            }else if(expressNumberType == 1){
                number = numbers[i].serial_number;
            }else if(expressNumberType == 2){
                if (serial_number) {
                    number = serial_number + "-" + (i + 1);
                } else {
                    number = i + 1;
                }
            }

            htmlStr += "<tr>";
            htmlStr += "<td>" + number + "</td>";
            htmlStr += "<td>";
            htmlStr += "<label class='control-label'>" + "{:L('WEIGHT')}" + ":</label>";
            htmlStr += "<div class='controls'>";
            htmlStr += "<input type='text' style='width: 90px;' onblur='weightItemBlur(this)' data-idx='" + (i + 1) + "' id='weight" + (i + 1) + "' name='weight" + (i + 1) + "'>{:L('WEIGHT_UNIT')}";
            htmlStr += "</div></td></tr>";
        }

        $("#item_table").html(htmlStr);
    }

    function weightItemBlur(obj) {
        var weight = obj.value;
        if (isNaN(weight)) {
            obj.value = "";
            return false;
        }

        if (weight > 0) {
            $("#weight").val(0);
            var quantity = $("#express_quantity").val();
            for (var i=1;i<=quantity;i++){
                $("#weight").val($("#weight"+i).val() * 1 + $("#weight").val() * 1);
            }
            $("#weight").blur();
        }
    }


    //界面初始化方法
    $(function () {
        //查询员工按钮点击事件
        $("#checkStaff").click(function () {
            console.log('check staff start');
            Wind.use('artDialog', 'iframeTools', function () {
                var url = "{:U('SystemUtil/index')}";
                art.dialog.open(url, {
                    title: '{:L("CHOSE_STAFF")}',
                    lock: true,
                    height: 400,
                    width: "80%",
                    // 在open()方法中，init会等待iframe加载完毕后执行
                    init: function () {
                        var iframe = this.iframe.contentWindow;
                        var top = art.dialog.top;// 引用顶层页面window对象
//                        var username = iframe.document.getElementById('xxxxx');
//                        username.value="hahahahaa";
//                        top.document.title = '测试';
                    },
                    ok: function () {
                        var iframe = this.iframe.contentWindow;
                        if (!iframe.document.body) {
                            alert('iframe还没加载完毕呢')
                            return false;
                        }

                        // 获取iframe嵌套内容
//                        var send_staff_id = iframe.document.getElementById('staff_id').value;
//                        document.getElementById("send_staff_id").value = send_staff_id;
                        //获取iframe内嵌信息的json
                        var send_staff_json = iframe.document.getElementById('staff_json').value;
                        getStaffByJson(send_staff_json);
                        return true;
                    },
                    cancel: true
                });
            });

        });

        //监听流水号输入框回车事件
        $('#serial_number').bind('keydown', function (event) {
            if (event.keyCode == "13") {
                getSendingExpress();
            }
        });

        //监听包裹数量变化
        $('#express_quantity').blur(function () {
            var quantity = $('#express_quantity').val();
            if (quantity != null && quantity != '') {
                if (isNaN(quantity)) {
                    $('#express_quantity').val(1);

                } else {
                    buildItem();
                }

            }
        });

        //表单提交
        $('#subbuttom').on("click", function (ev) {
//            return false;

            $('#sendForm').submit();
        });

        var form = $("form2");
        form.submit(function(ev){ev.preventDefault();});

    });

    
    function sendPackage($this) {
        if($("#package_address_id_form").val()!=""){
            var chk_value = [];
            //get checkbox value
            $('input[class="js-check"]:checked').each(function () {
                chk_value.push($(this).val());
            });
            if (chk_value.length == 0) {

            }else{
                $("#form2").attr("action","{:U('Sending/packageItem')}");
                $("#form2").submit();
            }

        }
    }

    function addressChange(){
        if($("#package_address_id_form").val()!=""){
            $("#form2").attr("action","{:U('Sending/createPackage')}");
            $("#form2").submit();
        }
    }

</script>
</body>
</html>